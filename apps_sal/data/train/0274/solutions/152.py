from sortedcontainers import SortedList


class Solution:

    def longestSubarray(self, nums: List[int], limit: int) -> int:
        s = SortedList()
        max_length = 0
        j = 0
        for i in range(len(nums)):
            s.add(nums[i])
            while s and s[-1] - s[0] > limit:
                s.remove(nums[j])
                j += 1
            max_length = max(max_length, i - j + 1)
        return max_length
        "\n        # i.e. if min is our problem then we need to increase i till we find new min \n        # i.e we need to start from i = i + max_index of current_min\n        # and if max is our problem then we need to increase i till we find new max\n        # i.e we need to start from i = i + max_index of current_max\n        # and if both are a problem then we need to increase i till max when both are changed\n        # this we can do if we use a hashmap mapping each value from i to j with its max index in the array we do not care for intermediate indices\n        max_length = -float('inf')\n        mapping = SortedDict()\n        Min = nums[0]\n        Max = nums[0]\n        mapping[Min] = 0\n        i = 0\n        while i < len(nums):\n            j = i\n            # print('a',i,j,Max,Min)\n            while j < len(nums) and abs(nums[j] - Min) <= limit and abs(nums[j] - Max) <= limit:\n                Max = max(Max,nums[j])\n                Min = min(Min,nums[j])\n                # we are just concerned with the max value\n                mapping[nums[j]] = j\n                j += 1\n                max_length = max(max_length,j - i)\n                \n            # print('b',i,j,Min,Max)\n            if j >= len(nums)-1:\n                break\n            else:\n                mapping[nums[j]] = j\n                while i <= j and (abs(nums[j] - Min) > limit or abs(nums[j] - Max) > limit):\n                    if abs(nums[j] - Min) > limit and abs(nums[j] - Max) > limit:\n                        i = max(i,max(mapping[Min],mapping[Max]) + 1)\n                        del mapping[Max]\n                        if Min in mapping.keys():\n                            del mapping[Min]\n\n                    elif abs(nums[j] - Min) > limit:\n                        i = max(i,mapping[Min] + 1)\n                        del mapping[Min]\n                        \n                    elif abs(nums[j] - Max) > limit:\n                        i = max(i,mapping[Max] + 1)\n                        del mapping[Max]\n                    # after each update we need to update min and max and the following steps will take O(n)\n                    Min = mapping.peekitem(0)[0]\n                    Max = mapping.peekitem()[0]\n                    while mapping[Min] < i:\n                        del mapping[Min]\n                        Min = mapping.peekitem(0)[0]\n                    while mapping[Max] < i:\n                        del mapping[Max]\n                        Max = mapping.peekitem()[0]\n                    \n                # print(mapping)\n                # print('c',i,j,Max,Min)\n        return max_length\n        \n        "
        "\n        max_length = -float('inf')\n        Min = nums[0]\n        Max = nums[0]\n        i = 0\n        while i < len(nums):\n            j = i \n            #print('a',i,j,Max,Min)\n            while j < len(nums) and abs(nums[j] - Min) <= limit and abs(nums[j] - Max) <= limit:\n                Max = max(Max,nums[j])\n                Min = min(Min,nums[j])\n                j += 1\n                max_length = max(max_length,j - i)\n            #print('b',i,j,Max,Min,len(nums))\n            if j >= len(nums)-1:\n                break\n            else:\n                while i < j and nums[i] != Min and nums[i] != Max:\n                    i += 1\n                while i < j and (abs(nums[j] - Min) > limit or abs(nums[j] - Max) > limit):\n                    i += 1\n                    #print(i)\n                    Min = min(nums[i:j+1])\n                    Max = max(nums[i:j+1])\n                    #print('c',i,j,Max,Min)\n        return max_length\n        "
